var Imageprocess=function(a,b){this.target=a;this.parameters=b;this.png=new Png;this.data=new Data};
Imageprocess.prototype.process=function(a){var b=this,c=new Deferred,d=new FileUpload(a.name,a.type,a.lastModified);console.log(a);this.data.readUrl(a).then(function(e){a.name.match(/\.png/)?b.compressPng(e).then(function(e){console.log("res",e);d.sent(b.data.blobToFile(e,a.name),b.target,b.parameters).then(function(a){c.resolve("png compressed and uploaded")})}):d.sent(b.data.blobToFile(e,a.name),b.target,b.parameters).then(function(a){c.resolve("image uploaded")})});return c.promise};
Imageprocess.prototype.compressPng=function(a){return this.png.compress(a)};var FileUpload=function(a,b,c,d){this.fileName=a;this.fileType=b;this.fileLastModified=d};FileUpload.prototype.sent=function(a,b,c){var d=this,e=new Deferred,f=new FormData;f.append("file",a);console.log(c);for(var g in c)f.append(g,c[g]);a=new XMLHttpRequest;a.open("POST",b);a.onload=function(a){console.log(d,a);e.resolve(a)};a.onerror=function(a){console.log("err",d,a);e.reject(a)};a.send(f);return e.promise};
var Png=function(){var a=this;this.data=new Data;this.worker=new Worker("worker.js");this.worker.addEventListener("message",function(b){var c=Object.keys(b.data)[0];return a["_"+c](b.data[c])},!1);this.worker.addEventListener("error",function(a){dd(a)},!1)};Png.prototype.compress=function(a){this.worker.postMessage({compress:{imageData:a,qualityMin:60,qualityMax:70,speed:2}});this.compressing=new Deferred;return this.compressing.promise};Png.prototype._init=function(a){console.log("init",a)};
Png.prototype._ready=function(a){console.log("ready",a)};Png.prototype._compressionDone=function(a){console.log("compressionDone",a.data);a=this.data.uint8ToBlob(a.data,"image/png");this.compressing.resolve(a)};Png.prototype._update=function(a){console.log("update",a)};var Data=function(){};Data.prototype.makeBlob=function(a){return blob=new Blob([fileData])};
Data.prototype.urlToUint8=function(a){a=a.split(",");a[0].match(/:(.*?);/);a=atob(a[1]);for(var b=a.length,c=new Uint8Array(b);b--;)c[b]=a.charCodeAt(b);return c};Data.prototype.uint8ToBlob=function(a,b){return new Blob([new Uint8Array(a)],{type:b})};Data.prototype.blobToFile=function(a,b){return new File([a],""+b)};Data.prototype.readUrl=function(a){var b=this,c=new Deferred,d=new FileReader;d.onload=function(a){c.resolve(b.urlToUint8(a.target.result))};d.readAsDataURL(a);return c.promise};
var Deferred=function(){var a=this;this.promise=new Promise(function(b,c){a.reject=c;a.resolve=b})};